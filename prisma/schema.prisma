generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Core ───────────────────────────────────────────────────────

model Company {
  id              String   @id @default(cuid())
  name            String
  address         String?
  phone           String?
  email           String?
  website         String?
  logoUrl         String?
  currency        String   @default("MYR")
  fiscalYearStart Int      @default(1) // Month number 1-12
  taxId           String?
  regNo           String?
  onboardingComplete Boolean @default(false)
  industry        String?  // e.g. 'retail', 'services', 'fnb', 'manufacturing'
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  users            User[]
  userCompanies    UserCompany[]
  accounts         Account[]
  contacts         Contact[]
  journalEntries   JournalEntry[]
  invoices         Invoice[]
  invoiceTemplates InvoiceTemplate[]
  customFields     CustomField[]
  products          Product[]
  taxEntities       TaxEntity[]
  currencies        Currency[]
  taxCodes          TaxCode[]
  tariffCodes       TariffCode[]
  productCategories ProductCategory[]
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  role         String   @default("user") // 'admin' | 'user'
  companyId    String                     // Currently active/selected company
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  company   Company       @relation(fields: [companyId], references: [id])
  companies UserCompany[]
}

// Join table: which companies a user has access to
model UserCompany {
  id        String   @id @default(cuid())
  userId    String
  companyId String
  role      String   @default("admin") // 'admin' | 'user' | 'viewer'
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
}

// ─── Chart of Accounts ──────────────────────────────────────────

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

model Account {
  id          String      @id @default(cuid())
  code        String
  name        String
  type        AccountType
  description String?
  parentId    String?
  isActive    Boolean     @default(true)
  companyId   String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  parent       Account?      @relation("AccountHierarchy", fields: [parentId], references: [id])
  children     Account[]     @relation("AccountHierarchy")
  company      Company       @relation(fields: [companyId], references: [id])
  journalLines JournalLine[]

  @@unique([code, companyId])
}

// ─── General Ledger ─────────────────────────────────────────────

model JournalEntry {
  id          String   @id @default(cuid())
  entryNo     String
  date        DateTime
  description String?
  reference   String?
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company Company       @relation(fields: [companyId], references: [id])
  lines   JournalLine[]

  @@unique([entryNo, companyId])
}

model JournalLine {
  id             String  @id @default(cuid())
  journalEntryId String
  accountId      String
  description    String?
  debit          Float   @default(0)
  credit         Float   @default(0)

  journalEntry JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      Account      @relation(fields: [accountId], references: [id])
}

// ─── Contacts ───────────────────────────────────────────────────

enum ContactType {
  CUSTOMER
  VENDOR
  BOTH
}

model Contact {
  id              String      @id @default(cuid())
  code            String?
  name            String
  email           String?
  phone           String?
  address         String?
  billingAddress  String?
  deliveryAddress String?
  sameAsBilling   Boolean     @default(true)
  taxId           String?
  brn             String?     // Business Registration No
  creditTerms     String?     // e.g. "Net 30", "Net 60", "COD"
  creditLimit     Float?
  type            ContactType @default(CUSTOMER)
  taxEntityId     String?
  companyId       String
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  company   Company    @relation(fields: [companyId], references: [id])
  taxEntity TaxEntity? @relation(fields: [taxEntityId], references: [id])
  invoices  Invoice[]
}

// ─── Tax Entity (Compliance) ────────────────────────────────────

model TaxEntity {
  id         String   @id @default(cuid())
  entityName String
  tin        String?  // LHDN Tax ID Number
  brn        String?  // Business Registration No (new format)
  sstNo      String?  // SST Registration No
  msicCode   String?  // MSIC Code
  companyId  String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  company  Company   @relation(fields: [companyId], references: [id])
  contacts Contact[]
}

// ─── Currency ───────────────────────────────────────────────────

model Currency {
  id           String   @id @default(cuid())
  code         String   // e.g. "MYR", "USD", "SGD"
  name         String   // e.g. "Malaysian Ringgit"
  symbol       String   // e.g. "RM", "$"
  exchangeRate Float    @default(1.0)
  isBase       Boolean  @default(false)
  isActive     Boolean  @default(true)
  companyId    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id])

  @@unique([code, companyId])
}

// ─── Tax Code ───────────────────────────────────────────────────

model TaxCode {
  id          String   @id @default(cuid())
  code        String   // e.g. "SR", "ZRL", "TX"
  description String   // e.g. "Standard Rate (6%)"
  rate        Float    @default(0) // Percentage, e.g. 6.0
  taxType     String   @default("OUTPUT") // "OUTPUT" | "INPUT" | "BOTH"
  isActive    Boolean  @default(true)
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id])

  @@unique([code, companyId])
}

// ─── Tariff Code ────────────────────────────────────────────────

model TariffCode {
  id          String   @id @default(cuid())
  code        String   // HS Tariff code, e.g. "8471.30.1000"
  description String
  isActive    Boolean  @default(true)
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id])

  @@unique([code, companyId])
}

// ─── Product Category ───────────────────────────────────────────

model ProductCategory {
  id          String   @id @default(cuid())
  code        String
  name        String
  description String?
  isActive    Boolean  @default(true)
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company  Company   @relation(fields: [companyId], references: [id])
  products Product[]

  @@unique([code, companyId])
}

// ─── Product / Inventory ────────────────────────────────────────

model Product {
  id           String   @id @default(cuid())
  code         String
  name         String
  category     String?
  categoryId   String?
  description  String?
  baseUom      String   @default("UNIT") // Unit of Measure
  defaultPrice Float    @default(0)
  defaultCost  Float    @default(0)
  hasVariants  Boolean  @default(false)
  isActive     Boolean  @default(true)
  companyId    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  company         Company          @relation(fields: [companyId], references: [id])
  productCategory ProductCategory? @relation(fields: [categoryId], references: [id])
  variants        ProductVariant[]

  @@unique([code, companyId])
}

model ProductVariant {
  id        String   @id @default(cuid())
  productId String
  name      String   // e.g. "Red", "Blue", "128GB"
  sku       String?
  price     Float?   // null = inherit from parent defaultPrice
  cost      Float?   // null = inherit from parent defaultCost
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// ─── Invoicing ──────────────────────────────────────────────────

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum DocType {
  INVOICE
  QUOTATION
  CREDIT_NOTE
  DEBIT_NOTE
}

model Invoice {
  id                String        @id @default(cuid())
  invoiceNo         String
  date              DateTime
  dueDate           DateTime
  contactId         String
  status            InvoiceStatus @default(DRAFT)
  docType           DocType       @default(INVOICE)
  subtotal          Float         @default(0)
  taxTotal          Float         @default(0)
  total             Float         @default(0)
  notes             String?
  customFieldValues Json?
  templateId        String?
  companyId         String
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  contact  Contact          @relation(fields: [contactId], references: [id])
  template InvoiceTemplate? @relation(fields: [templateId], references: [id])
  company  Company          @relation(fields: [companyId], references: [id])
  lines    InvoiceLine[]

  @@unique([invoiceNo, companyId])
}

model InvoiceLine {
  id          String  @id @default(cuid())
  invoiceId   String
  itemName    String
  itemCode    String?
  description String?
  quantity    Float   @default(1)
  unitPrice   Float   @default(0)
  discount    Float   @default(0)
  taxRate     Float   @default(0)
  amount      Float   @default(0)
  sortOrder   Int     @default(0)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

// ─── Template System (Feature 1) ────────────────────────────────

model InvoiceTemplate {
  id        String   @id @default(cuid())
  name      String
  isDefault Boolean  @default(false)
  docType   DocType  @default(INVOICE)
  config    Json
  companyId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company      Company       @relation(fields: [companyId], references: [id])
  customFields CustomField[]
  invoices     Invoice[]
}

model CustomField {
  id         String  @id @default(cuid())
  companyId  String
  templateId String
  section    String  // 'header' | 'docInfo' | 'billTo' | 'lineItems' | 'totals' | 'footer'
  fieldName  String  // Display label
  fieldKey   String  // Internal key
  fieldType  String  // 'text' | 'number' | 'date' | 'dropdown' | 'checkbox'
  isRequired Boolean @default(false)
  sortOrder  Int     @default(0)
  options    Json?   // For dropdown options
  defaultVal String?

  company  Company         @relation(fields: [companyId], references: [id])
  template InvoiceTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
}
